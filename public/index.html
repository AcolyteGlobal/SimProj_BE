<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
    <!-- Header -->
  <header class="flex items-center justify-between bg-gray-300 p-4">
    <!-- Logo (square-shaped) -->
    <div class="logo">
      <img src="./public/LogoAco.png" alt="Acolyte Technologies" class="w-12 h-12 rounded-md">
    </div>
<!-- Page Name -->
    <h2 class="text-xl font-semibold">Welcome to Acolyte Technologies</h2>
  </header>

<div id="app" class="max-w-7xl mx-auto">
  <!-- Content will be rendered here -->
</div>
    

  <script>
    const app = document.getElementById("app");

    /* ---------------- LOGIN COMPONENT ---------------- */
    function LoginComponent() {
      app.innerHTML = `
        <div class="max-w-md mx-auto bg-white p-6 rounded shadow">
          <h1 class="text-2xl font-bold mb-4">Admin Login</h1>
          <div id="errorMsg" class="text-red-600 mb-3 hidden"></div>
          <form id="loginForm" class="space-y-3">
            <input id="username" type="text" placeholder="Username" class="w-full p-2 border rounded">
            <input id="password" type="password" placeholder="Password" class="w-full p-2 border rounded">
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Login</button>
          </form>
        </div>
      `;

      document.getElementById("loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        try {
          const res = await fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
          });
          const data = await res.json();
          if (res.ok) {
            localStorage.setItem("token", data.token);
            DashboardComponent();
          } else {
            const errorMsg = document.getElementById("errorMsg");
            errorMsg.textContent = data.error || "Login failed";
            errorMsg.classList.remove("hidden");
          }
        } catch {
          alert("Login error, please try again.");
        }
      });
    }


    ///////////
  /* ---------------- PROTECTED COMPONENT ---------------- */
const ProtectedComponent = (() => {
  let loginMessage = "Please login to view this content.";

  // Optional: custom login message
  function setLoginMessage(msg) {
    loginMessage = msg;
  }

  // Render a component into a container by ID
  function render(sectionId, component) {
    const token = localStorage.getItem("token");
    const container = document.getElementById(sectionId);
    if (!container) return;

    if (!token) {
      container.innerHTML = `
        <div class="p-4 text-center text-red-600 font-bold">
          ${loginMessage}
        </div>
      `;
      return;
    }

    // Render the passed component
    if (component && typeof component.render === "function") {
      container.innerHTML = component.render();
    }
  }

  // Load event listeners / fetch data for a specific component
  async function load(sectionId, component) {
    const token = localStorage.getItem("token");
    const container = document.getElementById(sectionId);
    if (!container || !token) return;

    if (component && typeof component.load === "function") {
      await component.load();
    }
  }

  return { setLoginMessage, render, load };
})();/* ---------------- DASHBOARD COMPONENT ---------------- */
async function DashboardComponent() {
  app.innerHTML = `
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-gray-800">Acolyte Admin Dashboard</h1>
      <button id="logoutBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Logout</button>
    </div>

    <div id="dashboardSections">
      <div id="usersSection"></div>
      <div id="addUserSection"></div>
      <div id="simsSection"></div>
      <div id="addSimSection"></div>
      <div id="assignSimSection"></div>
      <div id="exitUserSection"></div>
      <div id="exitLogSection"></div>
    </div>
  `;

  // Logout button
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("token");
      LoginComponent();
    });
  }

  // ---------------- Protected sections ----------------
  const sections = [
    { id: "usersSection", component: UsersComponent },
    { id: "addUserSection", component: AddUserComponent },
    { id: "simsSection", component: SimsComponent },
    { id: "addSimSection", component: AddSimComponent },
    { id: "assignSimSection", component: AssignSimComponent },
    { id: "exitUserSection", component: ExitUserComponent },
    { id: "exitLogSection", component: ExitLogComponent }
  ];

  // Use for..of to handle async properly
  for (const sec of sections) {
    ProtectedComponent.render(sec.id, sec.component); // render per section
    await ProtectedComponent.load(sec.id, sec.component); // load per section
  }
}
/* ---------------- DASHBOARD COMPONENT ENDS ---------------- */



/* ---------------- INIT ---------------- */
async function init() {
  const token = localStorage.getItem("token");

  if (!token) {
    LoginComponent();
    return;
  }

  try {
    // Verify token with lightweight endpoint
    const res = await fetch("/users/max-bio", {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!res.ok) throw new Error("Token invalid");

    DashboardComponent();
  } catch (err) {
    console.warn("Token invalid, redirecting to login", err);
    localStorage.removeItem("token");
    LoginComponent();
  }
}

init();


    /* ---------------- DASHBOARD COMPONENT ENDS---------------- */

/* ---------------- USERS COMPONENT (Singleton) ---------------- */

/* ---------------- USERS COMPONENT (Singleton) ---------------- */
const UsersComponent = (() => {
  // ---------------- State ----------------
  let users = [];
  let page = 1;
  const limit = 10;
  let total = 0;
  let search = "";
  let filterActive = true;
  let filterDept = "";

  // API Base (explicit for CloudPanel / backend calls)
  const API_BASE = "http://localhost:4000";

  // ---------------- Render HTML ----------------
  function render() {
    const totalPages = Math.ceil(total / limit) || 1;

    return `
      <div class="p-4">
        <h2 class="text-2xl font-bold mb-6 text-black">Users</h2>

        <!-- Search + Filters -->
        <div class="flex flex-wrap gap-3 mb-6 items-center">
          <input 
            type="text" 
            id="searchInput" 
            placeholder="Search users..."
            class="border border-gray-300 rounded-lg p-2 flex-1 min-w-[200px]"
            value="${search}" 
          />
          <button id="searchBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Search
          </button>
          <label class="flex items-center gap-2 text-gray-700">
            <input type="checkbox" id="activeFilter" ${filterActive ? "checked" : ""} /> 
            Active Only
          </label>
          <select id="deptFilter" class="border border-gray-300 rounded-lg p-2">
            <option value="">All Departments</option>
            <option value="IT" ${filterDept === "IT" ? "selected" : ""}>IT</option>
            <option value="HR" ${filterDept === "HR" ? "selected" : ""}>HR</option>
            <option value="Finance" ${filterDept === "Finance" ? "selected" : ""}>Finance</option>
            <option value="Admin" ${filterDept === "Admin" ? "selected" : ""}>Admin</option>
          </select>
        </div>

        <!-- Users Table -->
        <div class="overflow-x-auto rounded-lg shadow">
          <table class="min-w-full border border-gray-200 text-sm">
            <thead class="bg-gray-200 text-black uppercase text-xs">
              <tr>
                <th class="px-3 py-2 text-left">User ID</th>
                <th class="px-3 py-2 text-left">Name</th>
                <th class="px-3 py-2 text-left">Branch</th>
                <th class="px-3 py-2 text-left">Office No.</th>
                <th class="px-3 py-2 text-left">Department</th>
                <th class="px-3 py-2 text-left">Biometric ID</th>
                <th class="px-3 py-2 text-left">Email</th>
                <th class="px-3 py-2 text-left">Phone</th>
                <th class="px-3 py-2 text-left">Status</th>
                <th class="px-3 py-2 text-left">Created</th>
                <th class="px-3 py-2 text-left">Updated</th>
                <th class="px-3 py-2 text-left">Handled By</th>
                <th class="px-3 py-2 text-left">SIM Number</th>
              </tr>
            </thead>
            <tbody id="usersTableBody" class="divide-y divide-gray-100">
              ${users.length
                ? users.map(u => `
                  <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2">${u.user_id}</td>
                    <td class="px-3 py-2">${u.name}</td>
                    <td class="px-3 py-2">${u.branch || "-"}</td>
                    <td class="px-3 py-2">${u.office_number || "-"}</td>
                    <td class="px-3 py-2">${u.department || "-"}</td>
                    <td class="px-3 py-2">${u.biometric_id}</td>
                    <td class="px-3 py-2">${u.official_email}</td>
                    <td class="px-3 py-2">${u.phone_number || "-"}</td>
                    <td class="px-3 py-2">${u.status}</td>
                    <td class="px-3 py-2">${u.created_at ? new Date(u.created_at).toLocaleDateString() : "-"}</td>
                    <td class="px-3 py-2">${u.updated_at ? new Date(u.updated_at).toLocaleDateString() : "-"}</td>
                    <td class="px-3 py-2">${u.handled_by_admin || "-"}</td>
                    <td class="px-3 py-2">${u.sim_number || "Not Assigned"}</td>
                  </tr>
                `).join("")
                : `<tr><td colspan="13" class="text-center py-6 text-gray-500">No users found</td></tr>`}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="flex justify-between items-center mt-6">
          <button 
            id="prevPageBtn" 
            class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 ${page === 1 ? "opacity-50 cursor-not-allowed" : ""}"
            ${page === 1 ? "disabled" : ""}
          >Prev</button>
          <span class="text-gray-700">Page ${page} of ${totalPages}</span>
          <button 
            id="nextPageBtn" 
            class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 ${page >= totalPages ? "opacity-50 cursor-not-allowed" : ""}"
            ${page >= totalPages ? "disabled" : ""}
          >Next</button>
        </div>

        <p class="text-gray-500 text-sm mt-4">
          ⚠️ Don’t search with Phone numbers.
        </p>
      </div>
    `;
  }

  // ---------------- Fetch Users ----------------
  async function fetchUsers(targetId = "usersSection") {
    const container = document.getElementById(targetId);
    const token = localStorage.getItem("token");

    if (!container) return;

    if (!token) {
      container.innerHTML = `<div class="p-4 text-center text-red-600 font-bold">Please login to view users.</div>`;
      return;
    }

    try {
      const query = new URLSearchParams({
        page,
        limit,
        search: search.trim(),
        active: filterActive ? "true" : "false",
        department: filterDept
      });

      const res = await fetch(`${API_BASE}/users?${query}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!res.ok) throw new Error((await res.json()).error || "Failed to fetch users");

      const data = await res.json();
      users = data?.users || [];
      total = data?.total || 0;

      container.innerHTML = render();
      attachListeners(targetId);

    } catch (err) {
      console.error("Error loading users:", err);
      container.innerHTML = `<p class="text-red-600">Error: ${err.message}</p>`;
    }
  }

  // ---------------- Attach Event Listeners ----------------
  function attachListeners(targetId) {
    const container = document.getElementById(targetId);
    if (!container) return;

    const searchInput = container.querySelector("#searchInput");
    const searchBtn = container.querySelector("#searchBtn");
    const prevBtn = container.querySelector("#prevPageBtn");
    const nextBtn = container.querySelector("#nextPageBtn");
    const totalPages = Math.ceil(total / limit) || 1;

    // Search
    searchInput?.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        search = searchInput.value;
        page = 1;
        fetchUsers(targetId);
      }
    });
    searchBtn?.addEventListener("click", () => {
      search = searchInput.value;
      page = 1;
      fetchUsers(targetId);
    });

    // Filters
    container.querySelector("#activeFilter")?.addEventListener("change", e => {
      filterActive = e.target.checked;
      page = 1;
      fetchUsers(targetId);
    });
    container.querySelector("#deptFilter")?.addEventListener("change", e => {
      filterDept = e.target.value;
      page = 1;
      fetchUsers(targetId);
    });

    // Pagination
    prevBtn?.addEventListener("click", () => {
      if (page > 1) {
        page--;
        fetchUsers(targetId);
      }
    });
    nextBtn?.addEventListener("click", () => {
      if (page < totalPages) {
        page++;
        fetchUsers(targetId);
      }
    });
  }

  return { render, load: fetchUsers, fetchUsers };
})();


    



// ---------------- PostUserComponent Singleton ----------------
/* ---------------- ADD NEW USER COMPONENT ---------------- */
/* ---------------- ADD USER COMPONENT (Singleton) ---------------- */
const AddUserComponent = (() => {
  const API_BASE = "http://localhost:4000"; // ✅ Backend base URL

  // ---------------- Render Form ----------------
  function render() {
    return `
      <div class="p-4">
        <h2 class="text-2xl font-bold mb-4">Add Users</h2>
        <textarea id="bulkUsersInput" 
          placeholder="Paste JSON array of users here..." 
          class="w-full border p-2 rounded h-40"></textarea>
        
        <button id="bulkAddBtn" 
          class="mt-3 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
          Add Users
        </button>
        
        <div id="bulkAddResult" class="mt-3 text-sm"></div>
      </div>
    `;
  }

  // ---------------- Bind Events ----------------
  function bindEvents() {
    const addBtn = document.getElementById("bulkAddBtn");
    const input = document.getElementById("bulkUsersInput");
    const result = document.getElementById("bulkAddResult");

    addBtn.addEventListener("click", async () => {
      try {
        // ✅ Parse textarea as JSON array
        const users = JSON.parse(input.value);

        if (!Array.isArray(users)) {
          result.textContent = "Input must be an array of users.";
          return;
        }

        // ✅ Call backend bulk API
        const res = await fetch(`${API_BASE}/users/bulk`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem("token")}` // ✅ Auth required
          },
          body: JSON.stringify({ users })
        });

        if (!res.ok) {
          const error = await res.json().catch(() => ({}));
          throw new Error(error.error || "Failed to add users");
        }

        const data = await res.json();
        result.textContent = `✅ Added ${data.insertedCount} users (by ${data.handled_by_admin})`;

        // Refresh UsersComponent after bulk insert
        if (window.UsersComponent) {
          UsersComponent.load();
        }
      } catch (err) {
        console.error("Add users failed:", err);
        result.textContent = `❌ Add users failed: ${err.message}`;
      }
    });
  }

  // ---------------- Public API ----------------
  return {
    render,
    bindEvents
  };
})();

    

    /* ---------------- SIMS COMPONENT ---------------- */
/* ---------------- SIMS COMPONENT ---------------- */
const SimsComponent = (() => {
  const state = { simsData: [], filteredData: [], currentPage: 1, limit: 10, totalPages: 1 };

  const populateTable = () => {
    const tbody = document.getElementById("simsBody");
    tbody.innerHTML = '';

    const start = (state.currentPage - 1) * state.limit;
    const end = start + state.limit;
    const pageData = state.filteredData.slice(start, end);

    
// Render each row

pageData.forEach(sim => {
  tbody.insertAdjacentHTML("beforeend", `
  <thead class="bg-gray-800 text-white">
    <tr class="w-full text-sm text-left text-white">
      <td class="px-4 py-3 text-gray-700 font-medium whitespace-nowrap">${sim.sim_id || '-'}</td>
      <td class="px-4 py-3 text-gray-700 whitespace-nowrap">${sim.phone_number || '-'}</td>
      <td class="px-4 py-3 text-gray-700 whitespace-nowrap">${sim.provider || '-'}</td>
      <td class="px-4 py-3">
        <span class="px-2 py-1 text-xs font-semibold rounded-full ${sim.status==='assigned' ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'}">
          ${sim.status || '-'}
        </span>
      </td>
      <td class="px-4 py-3 text-gray-700 whitespace-nowrap">${sim.assigned_user || '-'}</td>
      <td class="px-4 py-3 text-gray-700 whitespace-nowrap">${sim.added_date ? new Date(sim.added_date).toLocaleString() : '-'}</td>
      <td class="px-4 py-3 text-gray-700 whitespace-nowrap">${sim.updated_at ? new Date(sim.updated_at).toLocaleString() : '-'}</td>
      <td class="px-4 py-3 text-gray-700 whitespace-nowrap">${sim.handled_by_admin || '-'}</td>
    </tr>
    </thead>
  `);
});

// Update page info

    const pageInfo = document.getElementById("simsPageInfo");
    const prevBtn = document.getElementById("prevSimsBtn");
    const nextBtn = document.getElementById("nextSimsBtn");

    if (!pageInfo || !prevBtn || !nextBtn) return;

    pageInfo.textContent = `Page ${state.currentPage} of ${state.totalPages}`;
    prevBtn.disabled = state.currentPage === 1;
    nextBtn.disabled = state.currentPage === state.totalPages;
  };

  const search = () => {
    const query = document.getElementById("searchSimsInput").value.trim().toLowerCase();
    state.filteredData = !query
      ? state.simsData
      : state.simsData.filter(sim =>
          (sim.sim_id?.toString().toLowerCase().includes(query)) ||
          (sim.phone_number?.toLowerCase().includes(query))
        );
    state.currentPage = 1;
    state.totalPages = Math.ceil(state.filteredData.length / state.limit);
    populateTable();
  };

  const nextPage = () => {
    if (state.currentPage < state.totalPages) {
      state.currentPage++;
      populateTable();
    }
  };

  const prevPage = () => {
    if (state.currentPage > 1) {
      state.currentPage--;
      populateTable();
    }
  };

  const fetchSims = async () => {
    try {
      const token = localStorage.getItem("token");
      const res = await fetch('/sims', { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      const sims = Array.isArray(data) ? data : data.sims || [];

      state.simsData = sims;
      state.filteredData = sims;
      state.currentPage = 1;
      state.totalPages = Math.ceil(sims.length / state.limit);

      populateTable();
      document.getElementById("simsTableContainer")?.classList.remove("hidden");
    } catch (err) {
      console.error("Fetch Sims Failed:", err);
    }
  };

  const attachListeners = () => {
    document.getElementById("fetchSimsBtn")?.addEventListener("click", fetchSims);
    document.getElementById("prevSimsBtn")?.addEventListener("click", prevPage);
    document.getElementById("nextSimsBtn")?.addEventListener("click", nextPage);
    document.getElementById("searchSimsInput")?.addEventListener("keydown", e => {
      if (e.key === "Enter") search();
    });
  };

  return {
    render: () => `
      <div class="mb-6">
        <h2 class="text-xl font-semibold mb-2">Sims List</h2>

        <div class="mb-4">
          <input type="text" id="searchSimsInput" placeholder="Search by phone or SIM ID..."
            class="p-2 border rounded w-1/3">
          <button onclick="SimsComponent.search()" 
            class="ml-2 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Search</button>
        </div>

        <button id="fetchSimsBtn" 
                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 mb-2">
          Show Total Sims
        </button>

        <div class="overflow-x-auto rounded-lg shadow-lg hidden" id="simsTableContainer">
          <table id="simsTable" class="w-full text-sm text-left text-gray-600">
            <thead class="bg-gray-800 text-white">
              <tr>
                <th class="px-4 py-3">SIM ID</th>
                <th class="px-4 py-3">Phone Number</th>
                <th class="px-4 py-3">Provider</th>
                <th class="px-4 py-3">Status</th>
                <th class="px-4 py-3">Assigned User</th>
                <th class="px-4 py-3">Added Date</th>
                <th class="px-4 py-3">Updated Date</th>
                <th class="px-4 py-3">Handled By Admin</th>
              </tr>
            </thead>
            <tbody id="simsBody" class="bg-white divide-y divide-gray-200"></tbody>
          </table>


          <!-- Pagination -->
<div class="flex justify-between items-center mt-3">
  <button id="prevSimsBtn" 
          onclick="SimsComponent.prevPage()" 
          class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
    Prev
  </button>

  <span id="simsPageInfo" class="text-gray-700 font-semibold"></span>

  <button id="nextSimsBtn" 
          onclick="SimsComponent.nextPage()" 
          class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
    Next
  </button>
</div>



        </div>
      </div>
    `,

    load: () => {
      attachListeners();
    },

    search,
    fetchSims,
    nextPage,
    prevPage,
    populateTable,
  };
})();






    /* ---------------- SIMS COMPONENT ---------------- */




/* ---------------- SIM HISTORY COMPONENT ---------------- */
/* ---------------- SIM HISTORY COMPONENT ---------------- */
const SimHistoryComponent = (() => {
  return {
    state: {
      historyData: []
    },

    // Render HTML
    render: () => `
      <section class="mb-10">
        <h2 class="text-xl font-bold mb-4">SIM Assignment History</h2>
        <table class="min-w-full border">
          <thead>
            <tr class="bg-gray-200">
              <th class="px-4 py-2">SIM ID</th>
              <th class="px-4 py-2">Phone Number</th>
              <th class="px-4 py-2">Provider</th>
              <th class="px-4 py-2">Status</th>
              <th class="px-4 py-2">Assigned User</th>
              <th class="px-4 py-2">Latest Assigned Date</th>
              <th class="px-4 py-2">Added Date</th>
              <th class="px-4 py-2">Updated At</th>
              <th class="px-4 py-2">Handled by Admin</th>
            </tr>
          </thead>
          <tbody id="simHistoryTableBody"></tbody>
        </table>
      </section>
    `,

    // Load: fetch data
    load: () => {
      SimHistoryComponent.fetchHistory();
    },

    // Fetch SIM history
    fetchHistory: async () => {
      const token = localStorage.getItem("token");
      try {
        const res = await fetch("/sims", {
          method: "GET",
          headers: { "Authorization": `Bearer ${token}` }
        });

        const data = await res.json(); // <-- this is already an array
        SimHistoryComponent.state.historyData = data;

        const tbody = document.getElementById("simHistoryTableBody");
        tbody.innerHTML = "";

        data.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="px-4 py-2 border">${row.sim_id}</td>
            <td class="px-4 py-2 border">${row.phone_number}</td>
            <td class="px-4 py-2 border">${row.provider}</td>
            <td class="px-4 py-2 border ${row.status === 'assigned' ? 'text-green-600 font-bold' : 'text-gray-500'}">
              ${row.status}
            </td>
            <td class="px-4 py-2 border">${row.assigned_user || '-'}</td>
            <td class="px-4 py-2 border">${row.latest_assigned_date ? row.latest_assigned_date.split('T')[0] : '-'}</td>
            <td class="px-4 py-2 border">${row.added_date ? row.added_date.split('T')[0] : '-'}</td>
            <td class="px-4 py-2 border">${row.updated_at ? row.updated_at.split('T')[0] : '-'}</td>
            <td class="px-4 py-2 border">${row.handled_by_admin || '-'}</td>
          `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error("Fetch SIM history error:", err);
        alert("Failed to fetch SIM history");
      }
    }
  };
})();








   
/* ---------------- ADD NEW SIM COMPONENT ---------------- */
const AddSimComponent = (() => {
  return {
    state: {},

    render: () => `
      <section class="mb-6">
        <h2 class="text-xl font-semibold mb-4">Add New SIM(s)</h2>

        <form id="addSimForm" class="space-y-3 bg-white p-4 rounded shadow">
          <div>
            <label class="block font-semibold mb-1">Phone Numbers (comma separated):</label>
            <input type="text" id="phoneNumbers" placeholder="e.g. 9876543210,9876543211" 
                   class="p-2 border rounded w-1/2" required>
          </div>

          <div>
            <label class="block font-semibold mb-1">Provider(s) (optional, comma separated):</label>
            <input type="text" id="providers" placeholder="e.g. Airtel, Vodafone" 
                   class="p-2 border rounded w-1/2">
            <p class="text-gray-500 text-sm mt-1">
              If only one provider is specified, it will be used for all numbers.
            </p>
          </div>

          <button type="submit" 
                  class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            Add SIM(s)
          </button>
        </form>

        <div id="addSimMsg" class="mt-3 text-sm font-medium"></div>
      </section>
    `,

    load: () => {
      const form = document.getElementById("addSimForm");
      if (form) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          await AddSimComponent.addSims();
        });
      }
    },

    addSims: async () => {
      const phoneNumbersInput = document.getElementById("phoneNumbers").value.trim();
      const providersInput = document.getElementById("providers").value.trim();
      const msgDiv = document.getElementById("addSimMsg");

      if (!phoneNumbersInput) {
        msgDiv.textContent = "At least one phone number is required!";
        msgDiv.className = "text-red-600 mt-2 font-medium";
        return;
      }

      // Split and clean
      const numbers = phoneNumbersInput.split(",").map(n => n.trim()).filter(n => n);
      const providers = providersInput ? providersInput.split(",").map(p => p.trim()) : [];

      // If only one provider, repeat it for all numbers
      const providerList = providers.length === 1 ? Array(numbers.length).fill(providers[0]) : providers;

      // Prepare payload
      const payload = numbers.map((num, idx) => ({
        phone_number: num,
        provider: providerList[idx] || "Unknown"
      }));

      try {
        const token = localStorage.getItem("token");
        const res = await fetch("/sims/bulk", {  // backend route for bulk insert
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ sims: payload })
        });

        const data = await res.json();
        if (!res.ok) {
          msgDiv.textContent = data.error || "Failed to add SIM(s)";
          msgDiv.className = "text-red-600 mt-2 font-medium";
          return;
        }

        msgDiv.textContent = `${data.insertedCount} SIM(s) added successfully! Handled by: ${data.handled_by_admin}`;
        msgDiv.className = "text-green-600 mt-2 font-medium";

        document.getElementById("addSimForm").reset();

        // Refresh SimsComponent table
        if (typeof SimsComponent !== "undefined") SimsComponent.fetchSims();

      } catch (err) {
        console.error("Add SIMs Failed:", err);
        msgDiv.textContent = "Server error while adding SIM(s)";
        msgDiv.className = "text-red-600 mt-2 font-medium";
      }
    }
  };
})();









    /* ---------------- ASSIGN SIM COMPONENT ---------------- */
    /* ---------------- ASSIGN SIM COMPONENT ---------------- */
const AssignSimComponent = (() => {
  return {
    render: () => `
      <section class="mb-6 p-4 bg-white rounded-lg shadow-md">
        <h2 class="text-lg font-bold mb-4">Assign SIM</h2>
        <input type="number" id="assignBiometricId" placeholder="Biometric ID" 
          class="w-full p-2 border rounded mb-2"/>
        <input type="text" id="assignPhoneNumber" placeholder="Phone Number" 
          class="w-full p-2 border rounded mb-2"/>
        <button id="assignSimBtn" 
          class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
          Assign SIM
        </button>
        <div id="assignSimMessageBox" class="mt-2 text-sm"></div>
      </section>
    `,

    load: () => {
      document.addEventListener("click", async (e) => {
        if (e.target.id !== "assignSimBtn") return;

        const biometric_id = parseInt(document.getElementById("assignBiometricId").value);
        const phone_number = document.getElementById("assignPhoneNumber").value.trim();
        const messageBox = document.getElementById("assignSimMessageBox");

        messageBox.textContent = "";
        messageBox.className = "mt-2 text-sm";

        if (!biometric_id || !phone_number) {
          messageBox.textContent = "⚠️ Please fill all fields.";
          messageBox.classList.add("text-yellow-600");
          return;
        }

        const token = localStorage.getItem("token");

        try {
          let res = await fetch("/assign", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ biometric_id, phone_number })
          });

          let data = await res.json();

          if (res.status === 409 && data.requireConfirmation) {
            if (confirm(data.message)) {
              res = await fetch("/assign", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ biometric_id, phone_number, force: true })
              });
              data = await res.json();
            }
          }

          if (res.ok) {
            messageBox.textContent = `✅ ${data.message || "SIM assigned successfully"} by: ${data.handled_by_admin || "Unknown"}`;
            messageBox.classList.add("text-green-600");
          } else {
            messageBox.textContent = `❌ ${data.error || "Failed to assign SIM"}`;
            messageBox.classList.add("text-red-600");
          }

          document.getElementById("assignBiometricId").value = "";
          document.getElementById("assignPhoneNumber").value = "";

        } catch (err) {
          console.error(err);
          messageBox.textContent = "❌ Error assigning SIM";
          messageBox.classList.add("text-red-600");
        }
      });
    }
  };
})();





    /////====================================
    /* ---------------- EXIT USER COMPONENT ---------------- */
/* ---------------- EXIT USER COMPONENT ---------------- */


// ---------------- EXIT USER COMPONENT ----------------
// ---------------- EXIT USER COMPONENT ----------------
const ExitUserComponent = {
  render: () => {
    return `
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4">Exit User</h2>
        <form id="exitUserForm" class="space-y-4">
          <!-- Biometric ID -->
          <div>
            <label for="exitBiometricId" class="block font-medium text-gray-700">Biometric ID</label>
            <input 
              type="number" 
              id="exitBiometricId" 
              class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring focus:ring-indigo-200 focus:border-indigo-500"
              required
            />
          </div>

          <!-- Reason -->
          <div>
            <label for="exitReason" class="block font-medium text-gray-700">Reason for Exit</label>
            <textarea
              id="exitReason"
              class="mt-1 block w-full border border-gray-300 rounded-lg p-2 focus:ring focus:ring-indigo-200 focus:border-indigo-500"
              rows="3"
              required
            ></textarea>
          </div>

          <!-- Submit -->
          <button 
            type="submit"
            class="px-4 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700">
            Exit User
          </button>
        </form>
        <div id="exitMessage" class="mt-3 text-sm"></div>
      </div>
    `;
  },

  load: () => {
    const form = document.getElementById("exitUserForm");
    const messageBox = document.getElementById("exitMessage");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const biometricId = document.getElementById("exitBiometricId").value.trim();
      const reason = document.getElementById("exitReason").value.trim();

      try {
        const res = await fetch("/exit", {

          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("token")
          },
          body: JSON.stringify({ biometric_id: biometricId, reason })
        });

        const data = await res.json();

        if (!res.ok) {
          messageBox.textContent = `❌ ${data.message || "Failed to exit user"}`;
          messageBox.className = "mt-3 text-sm text-red-600";
        } else {
          messageBox.textContent = `✅ ${data.message || "User exited successfully"} by: ${data.handled_by_admin || "Unknown"}`;


          messageBox.className = "mt-3 text-sm text-green-600";
          form.reset();
        }
      } catch (err) {
        console.error("Exit User Error:", err);
        messageBox.textContent = "❌ Network error while exiting user";
        messageBox.className = "mt-3 text-sm text-red-600";
      }
    });
  }
};

////////////////////

// ---------------- EXIT LOG COMPONENT ----------------

// ---------------- EXIT LOG COMPONENT ----------------
// ---------------- EXIT LOG COMPONENT ----------------
const ExitLogComponent = (() => {
  return {
    state: {
      allLogsData: [],
      currentPage: 1,
      limit: 10,
      totalPages: 1
    },

    // Render Exit Log UI
    render: () => `
      <section class="mb-10">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Exit Logs</h2>

        <!-- Search + Page size -->
        <div class="mb-4 flex items-center space-x-3">
          <input type="text" id="exitSearchInput" placeholder="Search logs"
            class="p-2 border rounded-lg w-1/3 shadow-sm focus:ring focus:ring-green-300"
            onkeydown="if(event.key==='Enter'){ ExitLogComponent.search() }">
          <button onclick="ExitLogComponent.search()"
            class="px-4 py-2 bg-green-600 text-white rounded-xl shadow hover:bg-green-700">
            Search
          </button>
          <select id="exitPageSize" onchange="ExitLogComponent.changePageSize()"
            class="border p-2 rounded-lg shadow-sm">
            <option value="10" selected>10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto bg-white shadow rounded-lg">
          <table class="w-full text-sm text-left text-gray-600">
            <thead class="bg-gray-800 text-white">
                <tr>
        <th class="px-4 py-3">Exit ID</th>
        <th class="px-4 py-3">User ID</th>
        <th class="px-4 py-3">Name</th> <!-- Added Name column -->
        <th class="px-4 py-3">Exit Date</th>
        <th class="px-4 py-3">Reason</th>
        <th class="px-4 py-3">Handled By</th>
      </tr>
            </thead>
            <tbody id="exitLogsBody"></tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="flex justify-between items-center mt-4">
          <button onclick="ExitLogComponent.prevPage()"
            class="px-4 py-2 bg-gray-600 text-white rounded-xl shadow hover:bg-gray-700">
            Prev
          </button>
          <span id="exitPageInfo" class="text-gray-700 font-medium"></span>
          <button onclick="ExitLogComponent.nextPage()"
            class="px-4 py-2 bg-gray-600 text-white rounded-xl shadow hover:bg-gray-700">
            Next
          </button>
          <select id="exitPageSizeBottom" onchange="ExitLogComponent.changePageSize()"
            class="border p-2 rounded-lg shadow-sm ml-4">
            <option value="10" selected>10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
        </div>
      </section>
    `,

    // Load initial data
    load: async () => {
      await ExitLogComponent.fetchLogs();
    },

    // Fetch logs from API
    fetchLogs: async (page = 1) => {
      try {
        const token = localStorage.getItem("token");
        const limit = ExitLogComponent.state.limit;
        const res = await fetch(`/exit/logs?page=${page}&limit=${limit}`, {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("Failed to fetch exit logs");

        const { data, page: current, totalPages } = await res.json();

        ExitLogComponent.state.allLogsData = data;
        ExitLogComponent.state.currentPage = current;
        ExitLogComponent.state.totalPages = totalPages;

        ExitLogComponent.populateTable(data);
        ExitLogComponent.updatePaginationControls();
      } catch (err) {
        console.error("Fetch Exit Logs Failed:", err);
        alert("Error loading exit logs. Check if backend is running.");
      }
    },

    // Populate table
    populateTable: (logs) => {
      const tbody = document.getElementById("exitLogsBody");
      tbody.innerHTML = "";

      if (!logs || logs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-3">No logs found</td></tr>`;
        return;
      }

      logs.forEach(log => {
  tbody.insertAdjacentHTML("beforeend", `
    <tr>
      <td class="px-4 py-3">${log.exit_id}</td>
      <td class="px-4 py-3">${log.user_id}</td>
      <td class="px-4 py-3">${log.user_name || "-"}</td> <!-- added user name -->
      <td class="px-4 py-3">${log.exit_date || "-"}</td> <!-- exit date -->
      <td class="px-4 py-3">${log.reason || "-"}</td>
      <td class="px-4 py-3">${log.handled_by_admin || "-"}</td> <!-- handled by admin -->
    </tr>
  `);
});
    },

    // Pagination controls
    prevPage: () => {
      if (ExitLogComponent.state.currentPage > 1) {
        ExitLogComponent.fetchLogs(ExitLogComponent.state.currentPage - 1);
      }
    },
    nextPage: () => {
      if (ExitLogComponent.state.currentPage < ExitLogComponent.state.totalPages) {
        ExitLogComponent.fetchLogs(ExitLogComponent.state.currentPage + 1);
      }
    },
    updatePaginationControls: () => {
      document.getElementById("exitPageInfo").textContent = 
        `Page ${ExitLogComponent.state.currentPage} of ${ExitLogComponent.state.totalPages}`;
    },

    // Search locally
search: () => {
  const input = document.getElementById("exitSearchInput");
  if (!input) return; // safety check

  const query = input.value.trim().toLowerCase();
  if (!query) {
    // If empty, show all logs
    ExitLogComponent.populateTable(ExitLogComponent.state.allLogsData);
    return;
  }

  // Filter logs based on multiple fields
  const filtered = ExitLogComponent.state.allLogsData.filter(log =>
    (log.user_id?.toString().includes(query)) ||
    (log.user_name?.toLowerCase().includes(query)) ||
    (log.reason?.toLowerCase().includes(query)) ||
    (log.handled_by_admin?.toLowerCase().includes(query))
  );

  ExitLogComponent.populateTable(filtered);
},

    // Change page size
    changePageSize: () => {
      const size = parseInt(document.getElementById("exitPageSize").value);
      ExitLogComponent.state.limit = size;
      ExitLogComponent.fetchLogs(1);
    }
  };
})();







  </script>
</body>
</html>
